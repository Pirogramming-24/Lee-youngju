{% extends 'base.html' %}

{% block title %}ì•„ì´ë””ì–´ ê´€ë¦¬ - ë©”ì¸í˜ì´ì§€{% endblock %}

{% block extra_css %}
<style>
    .sort-buttons {
        margin-bottom: 20px;
    }
    .sort-buttons a {
        padding: 8px 15px;
        margin-right: 10px;
        text-decoration: none;
        background-color: #BDE8F5;
        color: #000000;
        border-radius: 5px;
    }
    .sort-buttons a.active {
        background-color: #1C4D8D;
        color: #FFFFFF;
    }
    .idea-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
        margin-bottom: 30px;
    }

    /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
    }
    .pagination a,
    .pagination span {
        padding: 8px 12px;
        border-radius: 5px;
        text-decoration: none;
        color: #1C4D8D;
        background: white;
    }
    .pagination .current {
        background: #0F2854;
        color: #FFFFFF;
        font-weight: bold;
    }
    .pagination .disabled {
        color: #4988C4;
        cursor: not-allowed;
    }
    .idea-card {
        border-radius: 8px;
        overflow: hidden;
        background: white;
        position: relative;
    }
    .idea-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background-color: #BDE8F5;
    }
    .idea-content {
        padding: 15px;
    }
    .title-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    .idea-title {
        font-size: 18px;
        font-weight: bold;
        color: #0F2854;
        text-decoration: none;
    }
    .idea-info {
        font-size: 14px;
        color: #000000;
        margin: 5px 0;
    }
    .star-button {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    .interest-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
    }
    .interest-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        background: white;
        color: #1C4D8D;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    .interest-value {
        font-weight: bold;
        min-width: 30px;
        text-align: center;
        color: #0F2854;
    }
</style>
{% endblock %}

{% block content %}
<h1>ì•„ì´ë””ì–´ ê´€ë¦¬</h1>

<div class="sort-buttons">
    <span>ì •ë ¬:</span>
    <a href="?sort=latest" class="{% if current_sort == 'latest' %}active{% endif %}">ìµœì‹ ìˆœ</a>
    <a href="?sort=oldest" class="{% if current_sort == 'oldest' %}active{% endif %}">ë“±ë¡ìˆœ</a>
    <a href="?sort=name" class="{% if current_sort == 'name' %}active{% endif %}">ì´ë¦„ìˆœ</a>
    <a href="?sort=star" class="{% if current_sort == 'star' %}active{% endif %}">ì°œí•˜ê¸°ìˆœ</a>
</div>

<div class="idea-grid">
    {% for idea in page_obj %}
    <div class="idea-card">
        <img src="{{ idea.image.url }}" alt="{{ idea.title }}" class="idea-image">

        <div class="idea-content">
            <div class="title-row">
                <a href="{% url 'idea:detail' idea.id %}" class="idea-title">{{ idea.title }}</a>
                <button class="star-button {% if idea.is_starred %}starred{% endif %}"
                        data-idea-id="{{ idea.id }}"
                        onclick="toggleStar({{ idea.id }}, this)">
                    <span class="star-icon">{% if idea.is_starred %}â¤ï¸{% else %}ğŸ©¶{% endif %}</span>
                </button>
            </div>
            <div class="idea-info">
                ê°œë°œíˆ´:
                {% for tool in idea.devtools.all %}
                    {{ tool.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </div>
            <div class="idea-info">ì°œ: <span class="star-count">{{ idea.star_count }}</span>ê°œ</div>

            <div class="interest-controls">
                <button class="interest-btn" onclick="adjustInterest({{ idea.id }}, 'decrease', this)">-</button>
                <span class="interest-value" data-idea-id="{{ idea.id }}">{{ idea.interest }}</span>
                <button class="interest-btn" onclick="adjustInterest({{ idea.id }}, 'increase', this)">+</button>
            </div>
        </div>
    </div>
    {% empty %}
    <p>ë“±ë¡ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
{% if page_obj.has_other_pages %}
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&sort={{ current_sort }}">â€¹</a>
    {% else %}
        <span class="disabled">â€¹</span>
    {% endif %}

    <span class="current">
        {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&sort={{ current_sort }}">â€º</a>
    {% else %}
        <span class="disabled">â€º</span>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleStar(ideaId, button) {
    const csrftoken = getCookie('csrftoken');

    fetch(`/idea/${ideaId}/toggle_star/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        const starIcon = button.querySelector('.star-icon');
        const card = button.closest('.idea-card');
        const starCountElement = card.querySelector('.star-count');

        if (data.is_starred) {
            button.classList.add('starred');
            starIcon.textContent = 'â¤ï¸';
        } else {
            button.classList.remove('starred');
            starIcon.textContent = 'ğŸ©¶';
        }

        starCountElement.textContent = data.star_count;
    })
    .catch(error => console.error('Error:', error));
}

function adjustInterest(ideaId, action, button) {
    const csrftoken = getCookie('csrftoken');

    fetch(`/idea/${ideaId}/adjust_interest/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=${action}`
    })
    .then(response => response.json())
    .then(data => {
        const interestValue = document.querySelector(`.interest-value[data-idea-id="${ideaId}"]`);
        interestValue.textContent = data.interest;
    })
    .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}
